\chapter{Infinitary Term Rewriting}\label{chap:rewriting}

This chapter does not contain original material.

Before we can study infinitary rewriting, we must introduce ordinal numbers.

Orthogonal TRSs have some nice properties, for example UN$^{\infty}$ and
compression.

% TODO: note that we are explicit in the wording: sequence vs rewrite sequence


\section{Ordinal Numbers}

% ordinals are origininally by Cantor

Ordinal numbers (ordinals for short) are an extension of the natural numbers
with transfinite objects. Indeed, the finite ordinals are just the natural
numbers. The smallest infinite ordinal is called $\omega$ and following
$\omega$ we have $\omega + 1$, $\omega + 2$, \ldots, $\omega \times 2$. Then
there are the ordinals $\omega \times 2 + 1$, $\omega \times 2 + 2$, \ldots,
$\omega \times 3$. Some other (still relatively small) ordinals are:
\begin{displaymath}
  \omega^2 \qquad
  \omega^\omega \qquad
  \omega^{\omega^2} \qquad
  \omega^{\omega^\omega} \qquad
  \omega^{\omega^{\omega^{\iddots}}} = \epsilon_0
\end{displaymath}
Note that this is all just notation, we have not yet defined a representation
for ordinals and what $+$ and $\times$ are.

In set theory, ordinals are usually represented by hereditarily transitive
sets. Zero corresponds to the empty set $\emptyset$, one to the singleton $\{
\emptyset \}$ and so on, and $\omega$ is represented by $\{ \emptyset, \{
\emptyset \}, \{ \emptyset, \{ \emptyset \} \} , \ldots \}$. Now $\in$
constitutes a well-founded total order on the ordinals.

We abbreviate $\alpha \cup \{ \alpha \}$ by $\alpha^+$ (corresponding to the
successor function) and say that $\alpha$ is a successor ordinal if $\alpha =
\beta^+$ for some ordinal $\beta$. If $\alpha$ is not a successor ordinal and
$\alpha \neq \emptyset$, it is called a limit ordinal. So an ordinal can
be either zero, a successor ordinal, or a limit ordinal.

From now on, we make no distinction between an ordinal and its set-theoretic
representation (e.g.\ between $0$ and $\emptyset$). Examples of successor
ordinals are $4$, $\omega + 7$  and $\omega^{\omega \times 2} + 1$. Examples
of limit ordinals are $\omega$ and $\omega \times 3$.

% TODO: we also make no distinction between the ordinal and its brouwer
% ordinal
% TODO: explain we use \lambda for limit ordinals

One can do arithmetics on ordinals much like we do arithmetics on natural
numbers. For example, addition can be defined by recursion on the right
argument:
\begin{align*}
  \alpha + 0       &= \alpha\\
  \alpha + \beta^+ &= (\alpha + \beta)^+\\
  \alpha + \lambda &= \bigcup \{ \alpha + \gamma \; | \; \gamma \in \lambda \}
\end{align*}


\subsection{Brouwer Ordinals}\label{sub:brouwer}

The Brouwer ordinals (also known as tree ordinals) are a constructive
representation of the countable ordinals as countably branching well-founded
trees. Their inductive definition uses constructors $0$ (zero), $^+$
(successor) and $\sqcup$ (limit).

% TODO: \mathcal{O} or \Omega?
The $\sqcup$ constructor has type $(\mathbb{N} \rightarrow \Omega) \rightarrow
\Omega$, but for our convenience we write $\sqcup_i \cdots i \cdots$ instead
of $\sqcup (\lambda i . \cdots i \cdots)$. Sometimes we explicitely enumerate
the function, writing for example $\sqcup \{ \alpha_1, \alpha_2, \alpha_3,
\ldots \}$.

% Be alerted that all ordinals cannot form a set (only a class), but we are
% defining a subset here
\begin{definition}\label{def:ordinals}%[Ordinals]
The set of \emph{Brouwer ordinals} (ordinals) $\Omega$ is defined by
induction:
\begin{compactenum}
  \item
    $0 \in \Omega$.
  \item
    If $\alpha \in \Omega$, then $\alpha^+ \in \Omega$.
  \item
    If $\alpha_i \in \Omega$ for all $i \in \mathbb{N}$, then $\sqcup_i
    \alpha_i \in \Omega$.
\end{compactenum}
\end{definition}

Now zero is represented by $0$, a successor ordinal $\alpha +1$ is represented
by $\alpha^+$ and a limit ordinal $\lambda$ is represented by $\sqcup_i
\alpha_i$ if $\lambda$ is the least upper bound of the sequence $\alpha_1,
\alpha_2, \alpha_3, \ldots$. % TODO: strict or unstrict upper bound
Again, we identify ordinals and their representation as Brouwer ordinal.

% TODO: some ordinals have no representation as Brouwer ordinal at all
Some ordinals have no unique representation as Brouwer ordinal. Consider for
example the limit ordinals $\sqcup_i i + 3$ and $\sqcup_i i \times 2$. Both
are representations of $\omega$ and a meaningful order relation would have to
position them at the same rank.

A more intricate issue is what to make of ordinals such as $\sqcup \{ 3, 3, 3,
\ldots \}$. In spirit of the intuition given above it represents $3$ ($4$),
that being the non-strict (strict) upper bound of $3, 3, 3, \ldots$.
% TODO: this makes it undecidable to compare an ordinal to 0 or 3
In practice, we might like to exclude such representations and require that
$\sqcup_i \alpha_i$ always represents a limit ordinal. This can be done by
imposing a strict monotonicity property on the limit sequences, but some order
relation on the Brouwer ordinals is needed for that.

% TODO: much of the following is taken from Hancock, but i think we cannot
% cite that paper. however, we must acknowledge this in some way

Before we can define an extensional order relation on $\Omega$, we define a
structural strict order relation as follows.
% TODO: , is too close on $\Omega$

\begin{definition}%[Predecessor indices]
The set-valued function $\Phi$ defines the \emph{predecessor indices} $\Phi(\alpha)$
\emph{for} $\alpha$ by recursion on $\alpha$:
\begin{align*}
  \Phi(0)                 &= \emptyset \\
  \Phi(\alpha^+)          &= \Phi(\alpha)^? \\
  \Phi(\sqcup_i \alpha_i) &= (\Sigma n \in \mathbb{N}) \; \Phi(\alpha_n)
\end{align*}
\end{definition}

By $A^?$ we mean the option type over $A$, or equivalently the disjoint sum
$1 + A$ of the unit type $1$ and $A$. We use \textsc{none} and \textsc{some
  $a$} (for $a \in A$) as constructors of $A^?$. Note that the set
$\Phi(0)$ of predecessor indices for $0$ is uninhabited.

\begin{definition}%[Predecessor]
The function $\_[\_] : (\prod \alpha : \Omega) \; \Phi(\alpha) \rightarrow
\Omega$ defines the \emph{predecessor} $\alpha[\iota]$ of $\alpha$
indexed by $\iota$ recursively on $\alpha$:
\begin{align*}
  \alpha^+[\textsc{none}]                     &= \alpha \\
  \alpha^+[\textsc{some $\iota$}]             &= \alpha[\iota] \\
  \sqcup_i \alpha_i[\langle n, \iota \rangle] &= \alpha_n[\iota]
\end{align*}
\end{definition}

% TODO: explain what I and _[_] mean

This structural predecessor function can be viewed as defining a `subtree'
partial order on $\Omega$. With it we are ready to define an extensional
non-strict order relation on $\Omega$ that classifies ordinals by rank.

% TODO: note <= infix notation
% TODO: or use the set-theoretic definitions from hancock?
% TODO: infix notations are used all the time, maybe state this at front
\begin{definition}\label{def:order}%[Order]
We define the \emph{order} $\preceq$ as a binary relation on $\Omega$ by
induction (and write $\alpha \preceq \beta$ for $\langle \alpha, \beta \rangle
\in \; \preceq$):
\begin{compactenum}
  \item
    $0 \preceq \beta$ for every ordinal $\beta \in \Omega$.
  \item\label{def:order:succ}
    For all $\alpha, \beta \in \Omega$ and $\iota \in \Phi(\beta)$, if
    $\alpha \preceq \beta[\iota]$ then $\alpha^+ \preceq \beta$.
  \item
    For all $\alpha_1, \alpha_2, \alpha_3, \ldots, \beta \in \Omega$, if
    $\alpha_n \preceq \beta$ for all $n \in \mathbb{N}$, then $\sqcup_i
    \alpha_i \preceq \beta$.
\end{compactenum}
\end{definition}

Using this order, we can define two other useful binary relations on
$\Omega$. First, the extensional equality $\alpha \simeq \beta$ by the
conjunction of $\alpha \preceq \beta$ and $\beta \preceq \alpha$. Second, the
extensional strict order $\alpha \prec \beta$ if $\alpha \preceq
\beta[\iota]$ for some $\iota \in \Phi(\beta)$.


\section{Term Rewriting}\label{sec:rewriting}

% TODO: Short motivation for term rewriting, summation of its applications and
% aspects of rewriting that are studied.

We give a short introduction to the basic notions of infinitary term
rewriting. For a more in-depth treatment of the theory of term rewriting,
consult~\cite{terese-03} (TODO: infinitary see chapter 12, others). In this
section, we use definitions and notations from Terese.

% TODO: rewrite this statement (and perhaps we never mention finitary
% rewriting)
From now on, we drop the `infinitary' from infinitary rewriting and
explicitely say so if we mean finitary rewriting.


\subsection{Definition of a TRS}\label{sub:trs}

\begin{definition}%[Signature]
A \emph{signature} $\Sigma$ is a non-empty set of \emph{function symbols} $f,
g, \ldots$. Each function symbol $f$ has a fixed natural number $\#f$, which
we call its \emph{arity}. A function symbol with arity $0$ is also called a
\emph{constant}.
\end{definition}

\begin{definition}%[Term]
The set of \emph{terms} $\TerI(X)$ over a signature $\Sigma$ and a
set of variables $X = \{x, y, \ldots\}$ is defined by coinduction:
\begin{compactenum}
  \item
    $x \in \TerI(X)$ for every variable $x \in X$.
  \item
    For every $f \in \Sigma$, if $t_1, \ldots, t_{\#f} \in \TerI(X)$,
    then $f(t_1, \ldots, t_{\#f}) \in \TerI(X)$.
%  \item
%    If $f$ is a function symbol with arity $n$ and $t_1, \ldots, t_n \in
%    \TerI(X)$, then $f(t_1, \ldots, t_n) \in \TerI(X)$.
\end{compactenum}
\end{definition}

The terms $t_i$ are called the \emph{arguments} of $f(t_1, \ldots, t_n)$ and
the symbol $f$ the \emph{root}. By $\Var(t)$ we denote the set of variables
occuring in $t$, and $t$ is \emph{closed} if $\Var(t) = \emptyset$. If no
variable occurs more than once in $t$, we say $t$ is \emph{linear}.
Often, the set of variables $X$ is left implicit and $\TerI(X)$ is
denoted simply by $\TerI$. By the set of \emph{finite terms} $\Ter$ we
mean the subset of well-founded terms of $\TerI$.

Preparing for the mechanized setting of Section~\ref{chap:implementation} with
its constrains of finite memory and computing time, we want to be precise
about the notions of equality on infinite objects we employ. We consider terms
to be equal if they are
\begin{inparaenum}[(i)]
  \item bisimilar or
  \item syntactically equivalent up to every depth.
\end{inparaenum} According to Proposition~\ref{prop:equalities} it does not
matter ultimately which equality we use.

\begin{definition}\label{def:bisimilarity}%[Bismilarity]
We define the \emph{bisimilarity relation} $\sim$ on $\TerI$ by
coinduction:
\begin{compactenum}
  \item
    $x \sim x$ for every variable $x \in X$.
  \item
    For every $f \in \Sigma$, if $s_i \sim t_i$ for all $1 \leq i \leq \#f$,
    then $f(s_1, \ldots s_{\#f}) \sim f(t_1, \ldots, t_{\#f})$.
\end{compactenum}
We say that $s$ and $t$ are \emph{bisimilar} if $s \sim t$.
\end{definition}

\begin{definition}\label{def:equiv}%[Syntactic equivalence]
\emph{(Syntactic) equivalence} of terms $s$ and $t$ \emph{up to depth} $d$,
written $s \equpto{d} t$, is defined by induction:
\begin{compactenum}
  \item $s \equpto{0} t$ for every $s, t \in \TerI$.
  \item $x \equpto{d} x$ for every $d \in \mathbb{N}$ and $x \in X$.
  \item For every $f \in \Sigma$, if $s_i \equpto{d} t_i$ for all $1 \leq i
    \leq \#f$, then $f(s_1, \ldots s_{\#f}) \equpto{d+1} f(t_1, \ldots,
    t_{\#f})$.
\end{compactenum}
The \emph{(syntactic) equivalence} $s \equiv t$ holds if $s \equpto{d} t$ for
every depth $d$.
\end{definition}

\begin{proposition}\label{prop:equalities}
$s \sim t \; \Leftrightarrow \; s \equiv t$.
\end{proposition}
\begin{proof}
By induction on the depth of syntactical equivalence ($\Rightarrow$) and by
coinduction on $s$ ($\Leftarrow$).
\footnote{This proposition is proved in our \Coq development.}
\end{proof}

\begin{definition}%[Rewrite rule]
  A \emph{rewrite rule} $\rho$ for a signature $\Sigma$ is a pair $\langle l,
  r \rangle$ of finite terms in $\Ter$ (written $\rho : l \rightarrow
  r$). We restrict ourselves to rewrite rules where $l$ is not a variable and
  $\Var(r) \subseteq \Var(l)$.
\end{definition}

We say a rewrite rule is \emph{left-linear} if its left-hand side is linear.

\begin{definition}%[TRS]
A \emph{term rewriting system} (TRS) $\mathcal{R}$ is a pair $\langle \Sigma,
R \rangle$ of a signature $\Sigma$ and a set of rewrite rules $R$ on
$\Sigma$.
\end{definition}

In contrast to \cite{terese-03}, we do not define contexts as terms over an
extended signature. Instead, a direct inductive definition is given since this
is how we defined the notion of context in our \Coq development (the main
reason being that we choose not to consider multi-hole contexts).
% TODO: maybe this needs more explaining

\begin{definition}%[Context]
The set of (one-hole) \emph{contexts} $\Ctx$ over a signature
$\Sigma$ is defined by induction:
\begin{compactenum}
  \item
    $\Box \in \Ctx$.
  \item
    For every $f \in \Sigma$ and $1 \le n \le \#f$, if $t_1, \ldots, t_{\#f -
      1} \in \TerI$ and $C \in \Ctx$, then $f(t_1, \ldots, t_{n - 1},
    C, t_{n + 1}, \ldots, t_{\#f - 1}) \in \Ctx$.
\end{compactenum}
\end{definition}

Thus every context $C$ has exactly one occurence of the symbol $\Box$, called
its \emph{hole}. By the term $C[t]$ we mean the result of replacing the hole
of $C$ by $t$. The \emph{hole depth} of a context $C$ is defined by the number
of `$($' symbols minus the number of `$)$' symbols preceeding the $\Box$
symbol in $C$.
TODO: this seemed to me the shortest way to define the hole depth?

\begin{definition}%[Substitution]
% TODO: now we only generalize to finite terms
Given a signature $\Sigma$ and a set of variables $X$, a \emph{substitution}
$\sigma$ is a mapping from $X$ to $\TerI(X)$. It can be
generalized to a mapping $\bar{\sigma} : \Ter(X) \rightarrow
\TerI(X)$ recursively:
\begin{align*}
  \bar{\sigma}(x) &= \sigma(x)\\
  \bar{\sigma}(f(t_1, \ldots, t_n)) &= f(\bar{\sigma}(t_1), \ldots,
  \bar{\sigma}(t_n))
\end{align*}
\end{definition}

Since $\bar{\sigma}$ is completely defined by $\sigma$ we refer to both as
`the' substitution $\sigma$. The notation $[x_1, \ldots, x_n := s_1, \ldots,
  s_n]$ is used for the substitution $\sigma$ with $\sigma(x_i) = s_i$ for $1
\leq i \leq n$ and $\sigma(y) = y$ for all other $y$. Applying a substitution
$\sigma$ to a term $t$ is usually written $t^\sigma$.

If we view a rewriting rule $\rho : l \rightarrow r$ as a \emph{scheme}, an
\emph{instance} of $\rho$ can be obtained by applying a substitution
$\sigma$. The result is the \emph{atomic} rewrite step $l^\sigma
\rightarrow_\rho r^\sigma$. We call $l^\sigma$ a ($\rho$-) \emph{redex} and
$r^\sigma$ its \emph{contractum}. An atomic rewrite step can be placed in a
context, forming a rewrite step.

\begin{definition}%[Rewrite step]
A \emph{rewrite step} $C[l^\sigma] \rightarrow_\rho C[r^\sigma]$ according to
$\rho$ consists of a rewrite rule $\rho : l \rightarrow r$, a substitution
$\sigma$ and a context $C$.
\end{definition}

The \emph{depth} of a rewrite step is the hole depth of its context.
We call $\rightarrow_\rho$ the \emph{one-step rewriting relation} generated by
$\rho$. The one-step rewriting relation $\rightarrow$ of a TRS $\mathcal{R}$
with rewrite rules $R$ is defined as the union of $\{ \rightarrow_\rho | \;
\rho \in R \}$.

\begin{definition}%[Rewrite sequence]
A \emph{rewrite sequence} of ordinal length $\alpha$ is a sequence of rewrite
steps $(t_\beta \rightarrow t_{\beta^+})_{\beta < \alpha}$.
\end{definition}

This definition only makes sense if we somehow require that for every limit
ordinal $\lambda < \alpha$, the terms $(t_\beta)_{\beta < \lambda}$ approach
$t_\lambda$ in the limit and sometimes even further restrictions are
desirable. We define the notion of Cauchy convergence and, using that, four
conditions on rewrite sequences.

\begin{definition}\label{def:cauchy}%[Cauchy convergence]
  A sequence of terms $(t_\beta)_{\beta < \alpha}$ \emph{(Cauchy-) converges}
  to the term $t$ if for every depth $d$ there exists $\beta < \alpha$ such
  that for all $\beta \le \gamma < \alpha$ we have $t_\gamma \equpto{d} t$.
\end{definition}

\begin{definition}%[Continuity and convergence]
A rewrite sequence $(t_\beta \rightarrow t_{\beta^+})_{\beta < \alpha}$ of
length $\alpha$ is
\begin{compactenum}
  \item
    \emph{weakly continuous} if for every limit ordinal $\lambda < \alpha$,
    the sequence $(t_\beta)_{\beta < \lambda}$ converges to the term
    $t_\lambda$,
  \item
    \emph{strongly continuous}, if it is weakly continuous and for every limit
    ordinal $\lambda < \alpha$, the depth of the rewrite steps $(t_\beta
    \rightarrow t_{\beta^+})_{\beta < \lambda}$ tends to infinity,
  \item
    \emph{weakly convergent} with limit $t_\alpha$, if for every limit ordinal
    $\lambda \leq \alpha$, the sequence $(t_\beta)_{\beta < \lambda}$
    converges to the term $t_\lambda$ and
  \item
    \emph{strongly convergent} with limit $t_\alpha$ if it is weakly
    convergent with limit $t_\alpha$ and for every limit ordinal $\lambda \leq
    \alpha$, the depth of the rewrite steps $(t_\beta \rightarrow
    t_{\beta^+})_{\beta < \lambda}$ tends to infinity.
\end{compactenum}
\end{definition}

% TODO: use ->> notation


\subsection{Normal Forms and Orthogonality}

TODO: here we probably cannot get away without definitions of position,
occurrence, and critical pair.

A term is a \emph{normal form} if it contains no redex occurrences.

%We say two rewrite rules $\rho_1 : l_1 \rightarrow r_2$ and $\rho_2 : l_2
%\rightarrow r_2$ overlap if there is a term $t$ with overlapping occurrences
%of the pattern of $l_1$ and the pattern of $l_2$.

%Two redex occurrences in a term $t$ overlap if their patterns share at least
%one symbol occurrence. Here we do not count the trivial overlap between a
%redex s and itself, unless s is a redex with respect to two different
%reduction rules.
%We say two rewrite rules $\rho_1, \rho_2$ overlap if there is a term $t$ with
%overlapping occurrences of a $\rho_1$- and $\rho_2$-redex.

\begin{definition}%[Orthogonality]
A TRS is called
\begin{compactenum}
  \item \emph{left-linear} if all its rewrite rules are left-linear,
  \item \emph{orthogonal} if it is left-linear and there are no critical pairs and
  \item \emph{weakly orthogonal} if it is left-linear and all critical pairs
    are trivial.
\end{compactenum}
\end{definition}

Orthogonal TRSs have unique normal forms. See Chapter~\ref{chap:unwo} for
weakly orthogonal TRSs.
