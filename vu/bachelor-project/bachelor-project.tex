\documentclass[a4paper,11pt]{article}
\usepackage[english]{babel}
\usepackage{a4}
\usepackage{amssymb}


\newtheorem{lemma}{Lemma}


\title{Vefifying a CPS Transformation (draft)}

\author{Martijn Vermaat\footnote{E-mail: \texttt{mvermaat@cs.vu.nl},
    homepage: \texttt{http://www.cs.vu.nl/\~{}mvermaat/}}}
\date{\today}


\begin{document}

\maketitle


\begin{abstract}
  Abstract.
\end{abstract}


\section{Introduction}\label{sec:introduction}


\section{Related Work}\label{sec:related}


\section{Proof}\label{sec:proof}

\begin{lemma}
  Let $K = \lambda^{0}.P$ be a $\kappa$-closed, one-argument
  abstraction of the target language. If $M \Rightarrow v$ in the
  source language, and $P\{\Psi(v)\}\{\} \Rightarrow v'$ in the target
  language, then $[\![M]\!](K) \Rightarrow v'$ in the target language.
\end{lemma}

\paragraph{Proof}

By induction on the derivation of $M \Rightarrow v$.

% TODO: check all reductions and add relevant properties (k-closedness
% of certain terms)
% TODO: make distinction clear between evaluation in source and target
% languages
% TODO: do lifting of x variables

\begin{itemize}
\item{Base case $\lambda^{n}.M' \Rightarrow \lambda^{n}.M'$}

  We need to show $[\![\lambda^{n}.M']\!](K) =
  (\lambda^{0}.\kappa_{0}(\Psi(\lambda^{n}.M'))) (\lambda^{0}.P)
  \Rightarrow v'$ assuming $P\{\Psi(\lambda^{n}.M')\}\{\} \Rightarrow
  v'$.

  % TODO: actually, beta-reduction is contained in the semantics...

  This is trivial, because
  $(\lambda^{0}.\kappa_{0}(\Psi(\lambda^{n}.M'))) (\lambda^{0}.P)
  \twoheadrightarrow_{\beta} P\{\Psi(\lambda^{n}.M')\}\{\}$.

\item{Case $M'(N_{0}, \ldots, N_{n}) \Rightarrow v$}

Premises are $M' \Rightarrow \lambda^{n}.P'$, $N_{i} \Rightarrow
v_{i}$, and $P'\{v_{n}, \ldots, v_{0}\} \Rightarrow v$.

Assuming $P\{\Psi(v)\}\{\} \Rightarrow v'$ we need to show
$[\![M'(N_{0}, \ldots, N_{n})]\!](\lambda^{0}.P) \Rightarrow v'$.

Working out the transformation $[\![\cdot]\!]$ and $\beta$-reduction,
we get
\begin{eqnarray*}
&   & [\![M'(N_{0}, \ldots, N_{n})]\!] (\lambda^{0}.P) \\
& = & (\lambda^{0}.[\![M'.N_{0} \ldots N_{n} \: \texttt{then} \: \kappa_{n+1}(\kappa_{n+2}, \kappa_{n}, \ldots, \kappa_{0})]\!]) (\lambda^{0}.P) \\
& = & (\lambda^{0}.[\![M']\!](\lambda^{0}.[\![N_{0}]\!](\lambda^{0}. \cdots [\![N_{n}]\!](\lambda^{0}.\kappa_{n+1}(\kappa_{n+2}, \kappa_{n}, \ldots, \kappa_{0})) \cdots ))) (\lambda^{0}.P) \\
& \rightarrow_{\beta} & [\![M']\!](\lambda^{0}.[\![N_{0}]\!](\lambda^{0}. \cdots [\![N_{n}]\!](\lambda^{0}.\kappa_{n+1}((\lambda^{0}.P), \kappa_{n}, \ldots, \kappa_{0})) \cdots ))
\end{eqnarray*}

Let $P'' = [\![N_{0}]\!](\lambda^{0}. \cdots [\![N_{n}]\!](\lambda^{0}.\kappa_{n+1}((\lambda^{0}.P), \kappa_{n}, \ldots, \kappa_{0})) \cdots )$ and $K' = \lambda^{0}.P''$. $K'$ is $\kappa$-closed ($[\![N_{i}]\!]$ is $\kappa$-closed by lemma 3).

Applying the induction hypothesis to our first premise, we know that $[\![M']\!](K') \Rightarrow v''$ assuming $P''\{\Psi(\lambda^{n}.P')\}\{\} \Rightarrow v''$.

\begin{eqnarray*}
&   & P''\{\Psi(\lambda^{n}.P')\}\{\} \\
& = & [\![N_{0}]\!](\lambda^{0}. \cdots [\![N_{n}]\!](\lambda^{0}.\Psi(\lambda^{n}.P')((\lambda^{0}.P), \kappa_{n}, \ldots, \kappa_{0})) \cdots )
\end{eqnarray*}

Our goal is to show $v'' = v'$ and we proceed by induction on $n$.

\begin{itemize}
\item{Base case $n = 0$}

$[\![N_{0}]\!](\lambda^{0}.\Psi(\lambda^{0}.P')((\lambda^{0}.P), \kappa_{0}))$

Let $K'' = \lambda^{0}.\Psi(\lambda^{0}.P')((\lambda^{0}.P), \kappa_{0})$ which is $\kappa$-closed by lemma 3. We apply the induction hypothesis to the premise $N_{0} \Rightarrow v_{0}$ yielding $[\![N_{0}]\!](K'') \Rightarrow v'''$ under assumption $\Psi(\lambda^{0}.P')((\lambda^{0}.P), \kappa_{0})\{\Psi(v_{0})\}\{\} \Rightarrow v'''$.

\begin{eqnarray*}
 &   & \Psi(\lambda^{0}.P')((\lambda^{0}.P), \kappa_{0})\{\Psi(v_{0})\}\{\} \\
 & = & \Psi(\lambda^{0}.P')((\lambda^{0}.P), \Psi(v_{0})) \\
 & = & (\lambda^{1}.[\![P']\!](\kappa_{0}))((\lambda^{0}.P), \Psi(v_{0})) \\
\mbox{(lemma 4)} & \rightarrow_{\beta} & [\![P']\!]\{\}\{\Psi(v_{0})\} (\lambda^{0}.P) \\
\mbox{(lemma 5)} & = & [\![P'\{v_{0}\}]\!] (\lambda^{0}.P)
\end{eqnarray*}

The result $[\![P'\{v_{0}\}]\!] (\lambda^{0}.P) \Rightarrow v'$
follows from the induction hypothesis applied to the last premise
$P'\{v_{0}\} \Rightarrow v$ and the assumption $P\{\Psi(v)\}\{\}
\Rightarrow v'$.


\item{Case $n = k + 1$}

$[\![N_{0}]\!](\lambda^{0}. \cdots [\![N_{k+1}]\!](\lambda^{0}.\Psi(\lambda^{k+1}.P')((\lambda^{0}.P), \kappa_{k+1}, \ldots, \kappa_{0})) \cdots )$

What is our IH and how can we use it? Maybe we should've started out with induction on $n$ (knowing $M'(N_{0}, \ldots, N_{n-1}) \Rightarrow \lambda^{0}.Q$ where $Q\{N_{n}\} = v$ or something)?


\end{itemize}

\item{Case $(\texttt{let} \: M' \: \texttt{in} \: N) \Rightarrow v$}

Premises are $M' \Rightarrow v_{1}$ and $N\{v_{1}\} \Rightarrow v$.

Assuming $P\{\Psi(v)\}\{\} \Rightarrow v'$ we need to show
$[\![\texttt{let} \: M' \: \texttt{in} \: N]\!](\lambda^{0}.P) \Rightarrow v'$.

\begin{eqnarray*}
                                     &             & [\![\texttt{let} \: M' \: \texttt{in} \: N]\!](\lambda^{0}.P) \\
                                     & =           & (\lambda^{0}.[\![M']\!](\lambda^{0}. \: \texttt{let} \: \kappa_{0} \: \texttt{in} \: [\![N]\!](\kappa_{1})))(\lambda^{0}.P) \\
\mbox{(application evaluation rule)} & \Rightarrow & [\![M']\!](\lambda^{0}. \: \texttt{let} \: \kappa_{0} \: \texttt{in} \: [\![N]\!](\Uparrow_{x}^{1} \lambda^{0}.P))
\end{eqnarray*}

We apply the induction hypothesis to the first premise (knowing that $\lambda^{0}. \: \texttt{let} \: \kappa_{0} \: \texttt{in} \: [\![N]\!](\Uparrow_{x}^{1} \lambda^{0}.P)$
is $\kappa$-closed) and the term evaluates as

\begin{eqnarray*}
\mbox{(IH on $M' \Rightarrow v_{1}$)}    & \Rightarrow & (\texttt{let} \: \kappa_{0} \: \texttt{in} \: [\![N]\!](\Uparrow_{x}^{1} \lambda^{0}.P))\{\Psi(v_{1})\}\{\} \\
                                        & =           & \texttt{let} \: \Psi(v_{1}) \: \texttt{in} \: [\![N]\!](\Uparrow_{x}^{1} \lambda^{0}.P) \\
\mbox{($\texttt{let}$-evaluation rule)} & \Rightarrow & ([\![N]\!](\Uparrow_{x}^{1} \lambda^{0}.P))\{\}\{\Psi(v_{1})\} \\
                                        & =           & [\![N]\!]\{\}\{\Psi(v_{1})\}(\Uparrow_{x}^{1} \lambda^{0}.P) \\
\mbox{(lemma 4)}                        & =           & [\![N\{v_{1}\}]\!](\Uparrow_{x}^{1} \lambda^{0}.P)
\end{eqnarray*}

Applying the induction hypothesis to the second premise (again, $\Uparrow_{x}^{1} \lambda^{0}.P$ is $\kappa$-closed)
completes our development

\begin{eqnarray*}
\mbox{(IH on $N\{v_{1}\} \Rightarrow v$)} & \Rightarrow & (\Uparrow_{x}^{1}P)\{\Psi(v)\}\{\} \\
\mbox{(assumption and \ldots)}           & \Rightarrow & v'
\end{eqnarray*}

% TODO: M => v if P => v might not imply M => P, but we write it this way in our developments (when using IH and let-evaluation rule)
% TODO: according to leroy, the lifting of x-variables disappears after a while. it is still there after IH on the first premise, but
%       no longer before applying lemma 4...
%       i think our proof still stands, except for the dots in the last step (there we need some substitution and lifting properties)


\end{itemize}


\section{Discussion}\label{sec:discussion}


\begin{thebibliography}{99}

\bibitem{Berg89}J. A. Bergstra, J. Heering, and P. Klint, editors. \emph{Algebraic
Specification}. ACM Press Frontier Series. The ACM Press in co-operation with Addison-Wesley,
1989.

\bibitem{Brab02}C. Brabrand and M. I. Schwartzbach. Growing languages with metamorphix
syntax macros. In \emph{PEPM'02}, 2002.

\bibitem{Brand00}M. G. J. van den Brand, H. de Jong, P. Klint, and P. Olivier. Efficient
annotated terms. \emph{Software, Practice \& Experience}, 30(3):259-291, 2000.

\bibitem{Brand02}M. G. J. van den Brand, J. Scheerder, J. Vinju, and E. Visser.
Disambiguation filters for scannerless generalized LR parsers. In N. Horspool, editor,
\emph{Compiler Construction (CC'02)}, volume 2304 of \emph{Lecture Notes in Computer
Science}, pages 143-158, Grenoble, France, April 2002. Springer-Verlag.

\bibitem{Brav04}M. Bravenboer, E. Visser. Concrete Syntax for Objects.
Domain-Specific Language Embedding and Assimilation without Restrictions. In Douglas
C. Schmidt (ed.) \emph{Proceedings of the 19th ACM SIGPLAN conference on
Object-Oriented Programming, Systems, Languages, and Applications (OOPSLA'04).}
Vancouver, Canada. October 2004.

\bibitem{Card94}L. Cardelli, F. Matthes, and M. Abadi. Extensible syntax with lexical
scoping. SRC Research Report 121, Digital Systems Research Center, Palo Alto,
California, Februari 1994.

\bibitem{Deur96}A. van Deursen, J. Heering, and P. Klint, editors. \emph{Language Prototyping.
An Algebraic Specification Approach}, volume 5 of \emph{AMAST Series in Computing} World
Scientific, Singapore, September 1996.

\bibitem{Leav66}B. M. Leavenworth. Syntax macros and extended translation. \emph{Communications
of the ACM}, 9(11):790-793, November 1966.

\bibitem{Sha96}A. Shalit. \emph{The Dylan reference manual: the definitive guide
to the new object-oriented dynamic language}. Addison Wesley Longman Publishing
Co., Inc., 1996.

\bibitem{Visser97}E. Visser. Scannerless generalized-LR parsing.
Technical Report P9707, Programming Research Group, University of Amsterdam, July 1997.

\bibitem{Visser97b}E. Visser. \emph{Syntax Definition for Language Prototyping.} PhD
thesis, University of Amsterdam, September 1997.

\bibitem{Vis02}E. Visser. Meta-programming with concrete object syntax. In D. Batory,
C. Consel, and W. Taha, editors, \emph{Generative Programming and Component Engineering
(GPCE'02)}, volume 2487 of \emph{Lecture Notes in Computer Science}, pages 299-315, Pittsburgh,
PA, USA, October 2002. Springer-Verlag.

\bibitem{Weis93}D. Weise and R. F. Crew. Programmable syntax macros. In \emph{Proceedings
of the ACM SIGPLAN '93 Conference on Programming Language Design and Implementation
(PLDI'93)}, Albuquerque, New Mexico, June 1993.

\end{thebibliography}


\end{document}
